<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>

    <!-- JS Cookie Lib -->
    <script src="{{ url_for('static', filename='external/js.cookie.js') }}"></script>

    <!-- Page Specific Javascript -->
    <script>
        $(document).ready(function() {
            // Obtaining the uid from the cookies
            var uid = Cookies.get('uid');
            if (uid == undefined) {
                // Redirect to login page
            }

            // Variables for uploading the file

            // Variable to store your files
            //var files;

            // Add events
            //$('input[type=file]').on('change', prepareUpload);

            // Grab the files and set them to our variable
            //function prepareUpload(event) {
            //  files = event.target.files;
            //}

            // Code for uploading image & later claiming it.
            var server_address = "http://localhost:7004";
            function uploadImage() {
                //var data = new FormData();
                //$.each(files, function(key, value) {
                //    data.append(key, value);
                //});
                var form_data = new FormData($('#upload-file')[0]);
                $.ajax({
                    type: 'POST',
                    url: server_address + '/image/upload',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    async: false,
                    success: function(data) {
                        console.log(data);
                        claimImage(data);
                    }
                });
                /*
                $.ajax({
                    method: 'POST',
                    url: server_address + '/image/upload',
                    data: form_data,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function(data) {
                        if (data.success) {
                            claimImage(data)
                        } else {
                            console.log(data);
                        }
                    }
                });
                */
            }

            function claimImage(data) {
                var image_title = $('#image_title').val();
                var image_id = data.image_id;
                var json_data = {
                    title: image_title,
                    uid: uid,
                    image_id: image_id
                };
                $.ajax({
                    method: 'POST',
                    url: server_address + '/image/claim',
                    data: JSON.stringify(json_data),
                    dataType: "json",
                    contentType: "application/json",
                    success: function(data) {
                        if (data.success) {
                            console.log("Success!");
                        } else {
                            console.log(data)
                        }
                    }
                })
            }
            $('#upload-file-btn').click(uploadImage);
        });
    </script>
</head>
<body>
    <div class="container">
        <!--
        <form action="#">
            <div class="file-field input-field">
                <div class="btn">
                    <span>File</span>
                    <input id="chosen_image" type="file" name="file">
                </div>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text">
                </div>
            </div>
            <div class="input-field col s6">
              <input placeholder="Untitled Image" id="title" type="text" class="validate">
              <label for="title"></label>
            </div>
            <a class="waves-effect waves-light btn" id="submit_button">Upload Image</a>
        </form>
        -->
        <form id="upload-file" method="post" enctype="multipart/form-data">
            <fieldset>
                <label for="file">Select a file</label>
                <input name="file" type="file">
            </fieldset>
            <fieldset>
                <label for="image_title">Image Title:</label>
                <input name="image_title" type="text">
            </fieldset>
            <fieldset>
                <button id="upload-file-btn" type="button">Upload</button>
            </fieldset>
        </form>
    </div>
</body>
</html>